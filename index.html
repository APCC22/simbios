<script>
  // Esta función se ejecutará automáticamente al cargar la página
  window.onload = function() {
    const corsProxy = 'https://api.allorigins.win/get?url=';
    const rssUrl = encodeURIComponent('https://www.simbiosiindustrial.cat/ofertes/exportXml2.php?coord=41.381788636,1.688750543&distance=18.5&tipologia');
    const fullUrl = corsProxy + rssUrl;

    fetch(fullUrl)
      .then(response => response.json())
      .then(data => {
        const xmlText = data.contents;
        const parser = new DOMParser();
        const xmlDoc = parser.parseFromString(xmlText, 'application/xml');
        
        const items = xmlDoc.getElementsByTagName('item');
        const container = document.getElementById('offer-container');
        const noOffersMessage = document.getElementById('no-offers');
        container.innerHTML = ''; // Limpiar contenedor antes de agregar nuevos ítems

        if (items.length === 0) {
          // Si no hay ítems, mostrar el mensaje de no ofertas
          noOffersMessage.style.display = 'block';
        } else {
          // Si hay ítems, ocultar el mensaje de no ofertas
          noOffersMessage.style.display = 'none';

          const offers = Array.from(items).map(item => {
            const title = item.getElementsByTagName('title')[0].textContent;
            const description = item.getElementsByTagName('description')[0].textContent;
            const link = item.getElementsByTagName('guid')[0].textContent;
            
            // Extraer la localitat de la descripció
            const localitatMatch = description.match(/Localitat:\s*([^<\n]+)/);
            const localitat = localitatMatch ? localitatMatch[1].trim() : '';

            // Separar la descripción por las palabras clave
            const descriptionParts = description.split(/(?=\bPreu|\bLocalitat|\bMaterial|\bTipologia|\bPes|\bUnitat)/);
            let formattedDescription = descriptionParts.map(part => {
              // Añadir un salto de línea solo después de las palabras clave y sus valores
              if (/Preu/.test(part)) {
                // Añadir €/Kg. al precio
                return `<p><strong>${part.trim()} €/Kg.</strong></p>`;
              } else if (/Localitat|Material|Tipologia|Pes|Unitat/.test(part)) {
                return `<p><strong>${part.trim()}</strong></p>`; // Poner la palabra clave en negrita
              } else {
                return `<p>${part.trim()}</p>`;
              }
            }).join('');

            return { title, formattedDescription, link, localitat };
          });

          // Ordenar les ofertes per localitat
          offers.sort((a, b) => a.localitat.localeCompare(b.localitat));

          // Mostrar les ofertes ordenades
          offers.forEach(offer => {
            const offerDiv = document.createElement('div');
            offerDiv.classList.add('offer-item');
            offerDiv.innerHTML = `
              <h3>${offer.title}</h3>
              ${offer.formattedDescription}
              <a href="${offer.link}" target="_blank">Accedir a l'oferta</a>
            `;
            container.appendChild(offerDiv);
          });
        }
      })
      .catch(error => {
        document.getElementById('offer-container').textContent = 'Error en carregar les ofertes: ' + error;
      });
  };
</script>
